<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox Token æµ‹è¯•</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .status {
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        .token-info {
            padding: 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .token-display {
            font-family: monospace;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            margin: 10px 0;
        }
        .test-results {
            padding: 20px;
            border-top: 1px solid #dee2e6;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ Mapbox Token æœ‰æ•ˆæ€§æµ‹è¯•</h1>
            <p>æµ‹è¯•æ‚¨çš„ Mapbox Access Token æ˜¯å¦å¯ä»¥æ­£å¸¸ä½¿ç”¨</p>
        </div>

        <div id="status" class="status loading">
            ğŸ”„ æ­£åœ¨æµ‹è¯• Token æœ‰æ•ˆæ€§...
        </div>

        <div id="map"></div>

        <div class="token-info">
            <h3>ğŸ“‹ Token ä¿¡æ¯</h3>
            <p><strong>æµ‹è¯•çš„ Token:</strong></p>
            <div class="token-display" id="token-display"></div>
            <p><strong>Token ç±»å‹:</strong> <span id="token-type"></span></p>
            <p><strong>æµ‹è¯•æ—¶é—´:</strong> <span id="test-time"></span></p>
        </div>

        <div class="test-results">
            <h3>ğŸ§ª æµ‹è¯•ç»“æœè¯¦æƒ…</h3>
            <div id="test-details"></div>
        </div>
    </div>

    <script>
        /**
         * æµ‹è¯• Mapbox Token çš„æœ‰æ•ˆæ€§
         * é€šè¿‡å°è¯•åˆ›å»ºåœ°å›¾å®ä¾‹æ¥éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ
         */
        function testMapboxToken() {
            // è¦æµ‹è¯•çš„ Token
            const token = 'pk.eyJ1IjoiZGVmaHR1ciIsImEiOiJjbWZueTh5anQwMDU2MnBwc2x1MTdvbTRyIn0.6wzewy9iWSbbpixDbjvXrw';
            
            // æ›´æ–°é¡µé¢ä¿¡æ¯
            updateTokenInfo(token);
            
            // è®¾ç½® Mapbox access token
            mapboxgl.accessToken = token;
            
            // æµ‹è¯•ç»“æœå®¹å™¨
            const testDetails = document.getElementById('test-details');
            const statusDiv = document.getElementById('status');
            
            let mapLoadSuccess = false;
            let mapInstance = null;
            
            try {
                // å°è¯•åˆ›å»ºåœ°å›¾å®ä¾‹ - ä½¿ç”¨ä¸é¡¹ç›®ç›¸åŒçš„æ ·å¼
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v11', // ä½¿ç”¨ä¸é¡¹ç›®ç›¸åŒçš„æ ·å¼ç‰ˆæœ¬
                    center: [116.3974, 39.9093], // åŒ—äº¬åæ ‡
                    zoom: 10,
                    attributionControl: true,
                    logoPosition: 'bottom-right'
                });

                mapInstance = map;
                addTestResult('åœ°å›¾å®ä¾‹åˆ›å»º', 'æˆåŠŸ', 'success');

                // ç›‘å¬åœ°å›¾åŠ è½½äº‹ä»¶
                map.on('load', function() {
                    mapLoadSuccess = true;
                    updateStatus('success', 'âœ… Token æœ‰æ•ˆï¼åœ°å›¾åŠ è½½æˆåŠŸ');
                    addTestResult('åœ°å›¾å®Œå…¨åŠ è½½', 'æˆåŠŸ', 'success');
                    addTestResult('åœ°å›¾æ ·å¼åŠ è½½', 'æˆåŠŸ', 'success');
                    addTestResult('Token éªŒè¯', 'é€šè¿‡', 'success');
                    
                    // æ·»åŠ ä¸€ä¸ªæ ‡è®°ç‚¹æµ‹è¯•
                    try {
                        new mapboxgl.Marker()
                            .setLngLat([116.3974, 39.9093])
                            .setPopup(new mapboxgl.Popup().setHTML('<h3>æµ‹è¯•æˆåŠŸï¼</h3><p>æ‚¨çš„ Mapbox Token å·¥ä½œæ­£å¸¸</p>'))
                            .addTo(map);
                        
                        addTestResult('æ ‡è®°ç‚¹æ·»åŠ ', 'æˆåŠŸ', 'success');
                    } catch (markerError) {
                        addTestResult('æ ‡è®°ç‚¹æ·»åŠ ', `å¤±è´¥: ${markerError.message}`, 'error');
                    }
                });

                // ç›‘å¬æ ·å¼åŠ è½½äº‹ä»¶
                map.on('styledata', function() {
                    addTestResult('æ ·å¼æ•°æ®åŠ è½½', 'æˆåŠŸ', 'success');
                });

                // ç›‘å¬æ•°æ®æºåŠ è½½äº‹ä»¶
                map.on('sourcedata', function(e) {
                    if (e.isSourceLoaded) {
                        addTestResult(`æ•°æ®æºåŠ è½½ (${e.sourceId})`, 'æˆåŠŸ', 'success');
                    }
                });

                // ç›‘å¬é”™è¯¯äº‹ä»¶ - æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
                map.on('error', function(e) {
                    console.error('åœ°å›¾é”™è¯¯:', e);
                    let errorMessage = 'æœªçŸ¥é”™è¯¯';
                    
                    if (e.error) {
                        errorMessage = e.error.message || e.error.toString();
                    } else if (e.sourceId) {
                        errorMessage = `æ•°æ®æº "${e.sourceId}" åŠ è½½å¤±è´¥`;
                    }
                    
                    addTestResult('åœ°å›¾åŠ è½½', `å¤±è´¥: ${errorMessage}`, 'error');
                    
                    // å¦‚æœæ˜¯æ•°æ®æºé”™è¯¯ï¼Œå°è¯•æä¾›è§£å†³æ–¹æ¡ˆ
                     if (e.sourceId && e.sourceId === 'composite') {
                         addTestResult('é”™è¯¯åˆ†æ', 'è¿™æ˜¯ Mapbox å†…éƒ¨æ•°æ®æºé—®é¢˜ï¼Œé€šå¸¸æ˜¯ä¸´æ—¶çš„ç½‘ç»œé—®é¢˜', 'error');
                         addTestResult('å»ºè®®è§£å†³æ–¹æ¡ˆ', '1. åˆ·æ–°é¡µé¢é‡è¯• 2. æ£€æŸ¥ç½‘ç»œè¿æ¥ 3. ç¨åå†è¯•', 'error');
                     }
                     
                     // æ£€æŸ¥æ˜¯å¦æ˜¯403é”™è¯¯ï¼ˆåŸŸåé™åˆ¶ï¼‰
                     if (errorMessage.includes('403') || errorMessage.includes('Forbidden')) {
                         addTestResult('403é”™è¯¯åˆ†æ', 'Tokenå¯èƒ½æœ‰åŸŸåé™åˆ¶ï¼Œä¸å…è®¸ä»å½“å‰åŸŸåè®¿é—®', 'error');
                         addTestResult('åŸŸåé™åˆ¶è§£å†³æ–¹æ¡ˆ', '1. åœ¨Mapboxæ§åˆ¶å°æ·»åŠ å½“å‰åŸŸååˆ°ç™½åå• 2. ä½¿ç”¨æ— åŸŸåé™åˆ¶çš„Token 3. åœ¨å¼€å‘æœåŠ¡å™¨ä¸­æµ‹è¯•', 'error');
                     }
                    
                    // å¦‚æœåœ°å›¾æ²¡æœ‰æˆåŠŸåŠ è½½ï¼Œæ›´æ–°çŠ¶æ€
                    if (!mapLoadSuccess) {
                        updateStatus('error', 'âš ï¸ Token æœ‰æ•ˆä½†åœ°å›¾åŠ è½½é‡åˆ°é—®é¢˜');
                    }
                });

                // ç›‘å¬æ ·å¼åŠ è½½é”™è¯¯
                map.on('style.error', function(e) {
                    console.error('æ ·å¼é”™è¯¯:', e);
                    const errorMsg = e.error ? e.error.message : 'æ ·å¼åŠ è½½å¤±è´¥';
                    addTestResult('æ ·å¼åŠ è½½', `å¤±è´¥: ${errorMsg}`, 'error');
                });

                // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                setTimeout(() => {
                    if (!mapLoadSuccess) {
                        addTestResult('åŠ è½½è¶…æ—¶æ£€æŸ¥', 'åœ°å›¾åŠ è½½è¶…è¿‡10ç§’ï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜', 'error');
                        // ä½†ä¸æ›´æ–°æ•´ä½“çŠ¶æ€ï¼Œå› ä¸º Token æœ¬èº«å¯èƒ½æ˜¯æœ‰æ•ˆçš„
                    }
                }, 10000);

            } catch (error) {
                console.error('åˆ›å»ºåœ°å›¾å¤±è´¥:', error);
                updateStatus('error', 'âŒ Token æ— æ•ˆæˆ–åˆ›å»ºåœ°å›¾å¤±è´¥');
                addTestResult('åœ°å›¾å®ä¾‹åˆ›å»º', `å¤±è´¥: ${error.message}`, 'error');
            }

            // é¢å¤–çš„ API æµ‹è¯•
            testMapboxAPI(token);
            
            // æµ‹è¯•ä¸åŒçš„åœ°å›¾æ ·å¼
            testAlternativeStyles(token);
            
            // æ£€æµ‹åŸŸåé™åˆ¶
            checkDomainRestrictions(token);
        }

        /**
         * æµ‹è¯• Mapbox API çš„ç›´æ¥è®¿é—®
         * @param {string} token - Mapbox access token
         */
        async function testMapboxAPI(token) {
            try {
                // æµ‹è¯• Mapbox API ç«¯ç‚¹ - ä½¿ç”¨ä¸é¡¹ç›®ç›¸åŒçš„æ ·å¼
                const response = await fetch(`https://api.mapbox.com/styles/v1/mapbox/streets-v11?access_token=${token}`);
                
                if (response.ok) {
                    addTestResult('API ç›´æ¥è®¿é—®', 'æˆåŠŸ', 'success');
                    const data = await response.json();
                    addTestResult('æ ·å¼æ•°æ®è·å–', `æˆåŠŸ (ç‰ˆæœ¬: ${data.version || 'N/A'})`, 'success');
                } else {
                    addTestResult('API ç›´æ¥è®¿é—®', `å¤±è´¥ (çŠ¶æ€ç : ${response.status})`, 'error');
                }
            } catch (error) {
                addTestResult('API ç›´æ¥è®¿é—®', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        /**
         * æµ‹è¯•ä¸åŒçš„åœ°å›¾æ ·å¼ä»¥éªŒè¯Tokenå…¼å®¹æ€§
         * @param {string} token - Mapbox access token
         */
        async function testAlternativeStyles(token) {
            const styles = [
                { name: 'Streets v11', url: 'mapbox://styles/mapbox/streets-v11' },
                { name: 'Outdoors v12', url: 'mapbox://styles/mapbox/outdoors-v12' },
                { name: 'Light v11', url: 'mapbox://styles/mapbox/light-v11' },
                { name: 'Satellite v9', url: 'mapbox://styles/mapbox/satellite-v9' }
            ];

            for (const style of styles) {
                try {
                    const apiUrl = style.url.replace('mapbox://styles/', 'https://api.mapbox.com/styles/v1/');
                    const response = await fetch(`${apiUrl}?access_token=${token}`);
                    
                    if (response.ok) {
                        addTestResult(`æ ·å¼å…¼å®¹æ€§ (${style.name})`, 'æ”¯æŒ', 'success');
                    } else {
                        addTestResult(`æ ·å¼å…¼å®¹æ€§ (${style.name})`, `ä¸æ”¯æŒ (${response.status})`, 'error');
                    }
                } catch (error) {
                    addTestResult(`æ ·å¼å…¼å®¹æ€§ (${style.name})`, `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
                
                // é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }

        /**
         * æ£€æµ‹Tokençš„åŸŸåé™åˆ¶
         * @param {string} token - Mapbox access token
         */
        async function checkDomainRestrictions(token) {
            const currentDomain = window.location.hostname || 'localhost';
            const currentProtocol = window.location.protocol;
            const currentPort = window.location.port;
            const fullDomain = `${currentProtocol}//${currentDomain}${currentPort ? ':' + currentPort : ''}`;
            
            addTestResult('å½“å‰è®¿é—®åŸŸå', fullDomain, 'success');
            
            // æµ‹è¯•ä»ä¸åŒæ¥æºè®¿é—®API
            try {
                const testUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/beijing.json?access_token=${token}&limit=1`;
                const response = await fetch(testUrl);
                
                if (response.status === 403) {
                    addTestResult('åŸŸåé™åˆ¶æ£€æµ‹', 'æ£€æµ‹åˆ°403é”™è¯¯ - Tokenæœ‰åŸŸåé™åˆ¶', 'error');
                    addTestResult('è§£å†³æ–¹æ¡ˆ1', 'åœ¨Mapboxæ§åˆ¶å°çš„Tokenè®¾ç½®ä¸­æ·»åŠ å½“å‰åŸŸååˆ°å…è®¸åˆ—è¡¨', 'error');
                    addTestResult('è§£å†³æ–¹æ¡ˆ2', 'åˆ›å»ºä¸€ä¸ªæ–°çš„æ— åŸŸåé™åˆ¶çš„Tokenç”¨äºå¼€å‘æµ‹è¯•', 'error');
                    addTestResult('è§£å†³æ–¹æ¡ˆ3', 'åœ¨Vueå¼€å‘æœåŠ¡å™¨(http://localhost:3001)ä¸­æµ‹è¯•ï¼Œè€Œä¸æ˜¯ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶', 'error');
                } else if (response.ok) {
                    addTestResult('åŸŸåé™åˆ¶æ£€æµ‹', 'æœªæ£€æµ‹åˆ°åŸŸåé™åˆ¶ - Tokenå¯ä»å½“å‰åŸŸåè®¿é—®', 'success');
                } else {
                    addTestResult('åŸŸåé™åˆ¶æ£€æµ‹', `å…¶ä»–é”™è¯¯ (çŠ¶æ€ç : ${response.status})`, 'error');
                }
            } catch (error) {
                addTestResult('åŸŸåé™åˆ¶æ£€æµ‹', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        /**
         * æ›´æ–°é¡µé¢çŠ¶æ€æ˜¾ç¤º
         * @param {string} type - çŠ¶æ€ç±»å‹ (success, error, loading)
         * @param {string} message - çŠ¶æ€æ¶ˆæ¯
         */
        function updateStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        /**
         * æ›´æ–° Token ä¿¡æ¯æ˜¾ç¤º
         * @param {string} token - Mapbox access token
         */
        function updateTokenInfo(token) {
            document.getElementById('token-display').textContent = token;
            document.getElementById('token-type').textContent = token.startsWith('pk.') ? 'å…¬å¼€ Token (é€‚ç”¨äºå‰ç«¯)' : 'ç§å¯† Token (ä¸é€‚ç”¨äºå‰ç«¯)';
            document.getElementById('test-time').textContent = new Date().toLocaleString('zh-CN');
        }

        /**
         * æ·»åŠ æµ‹è¯•ç»“æœé¡¹
         * @param {string} testName - æµ‹è¯•åç§°
         * @param {string} result - æµ‹è¯•ç»“æœ
         * @param {string} type - ç»“æœç±»å‹ (success, error)
         */
        function addTestResult(testName, result, type) {
            const testDetails = document.getElementById('test-details');
            const testItem = document.createElement('div');
            testItem.className = 'test-item';
            
            const icon = type === 'success' ? 'âœ…' : 'âŒ';
            testItem.innerHTML = `<strong>${icon} ${testName}:</strong> ${result}`;
            
            if (type === 'error') {
                testItem.style.borderLeftColor = '#dc3545';
                testItem.style.backgroundColor = '#f8d7da';
            } else {
                testItem.style.borderLeftColor = '#28a745';
                testItem.style.backgroundColor = '#d4edda';
            }
            
            testDetails.appendChild(testItem);
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿä¸€ç§’å¼€å§‹æµ‹è¯•ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŠ è½½çŠ¶æ€
            setTimeout(testMapboxToken, 1000);
        });
    </script>
</body>
</html>